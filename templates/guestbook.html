{% extends "_base.html" %} {% block head %}
<title>miniex::guestbook</title>
<meta name="description" content="{{ t.guestbook_subtitle }}" />
<meta property="og:title" content="miniex::guestbook" />
<meta property="og:description" content="{{ t.guestbook_subtitle }}" />
<meta property="og:type" content="website" />
<meta property="og:url" content="https://miniex.blog/guestbook" />
<meta property="og:site_name" content="miniex.blog" />
<meta
  property="og:image"
  content="https://miniex.blog/assets/favicon/sakura-flower-512-238032.png"
/>
<meta property="og:locale" content="{{ lang.as_str() }}" />
<link rel="canonical" href="https://miniex.blog/guestbook" />
{% endblock %} {% block main %}
<div class="container mx-auto px-3 sm:px-4 max-w-3xl">
  <!-- Header -->
  <div class="text-center mb-10">
    <div class="inline-flex items-center gap-2 px-3 py-1.5 rounded-full bg-primary/6 border border-primary/10 mb-4">
      <i class="ph ph-chat-circle text-sm text-primary/60"></i>
      <span class="text-xs font-medium text-primary/70">{{ total_entries }} messages</span>
    </div>
    <h1 class="text-3xl sm:text-4xl font-bold mb-3 text-base-content tracking-tight">
      {{ t.guestbook_title }}
    </h1>
    <p class="text-base-content/45 max-w-lg mx-auto text-sm leading-relaxed">
      {{ t.guestbook_subtitle }}
    </p>
  </div>

  <!-- Write New Entry -->
  <div class="relative overflow-hidden rounded-2xl border border-base-300/20 mb-10">
    <div class="absolute top-0 left-0 w-full h-0.5 bg-gradient-to-r from-primary/30 via-secondary/30 to-accent/30"></div>
    <div class="p-5 sm:p-7">
      <div class="flex items-center gap-2.5 mb-5">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary/12 to-secondary/12 flex items-center justify-center">
          <i class="ph ph-pencil-simple text-primary/60 text-sm"></i>
        </div>
        <h2 class="text-base font-semibold">{{ t.guestbook_write_new }}</h2>
      </div>

      <form id="guestbook-form" class="space-y-4">
        <div class="grid grid-cols-1 sm:grid-cols-2 gap-4">
          <div>
            <label class="block text-xs font-medium text-base-content/55 mb-1.5 ml-1" for="author">
              {{ t.guestbook_name }}
            </label>
            <input
              type="text"
              id="author"
              name="author"
              placeholder="{{ t.guestbook_name_placeholder }}"
              class="input input-bordered input-sm w-full rounded-xl bg-base-200/20 border-base-300/25 focus:border-primary/30 focus:bg-base-100 transition-all duration-200 h-10"
              required
              autocomplete="off"
            />
          </div>
          <div>
            <label class="block text-xs font-medium text-base-content/55 mb-1.5 ml-1" for="password">
              {{ t.guestbook_password }}
              <span class="text-base-content/30 font-normal ml-1">{{ t.guestbook_password_hint }}</span>
            </label>
            <input
              type="password"
              id="password"
              name="password"
              placeholder="{{ t.guestbook_password_placeholder }}"
              class="input input-bordered input-sm w-full rounded-xl bg-base-200/20 border-base-300/25 focus:border-primary/30 focus:bg-base-100 transition-all duration-200 h-10"
              autocomplete="new-password"
            />
          </div>
        </div>

        <div>
          <label class="block text-xs font-medium text-base-content/55 mb-1.5 ml-1" for="content">
            {{ t.guestbook_message }}
          </label>
          <textarea
            id="content"
            name="content"
            placeholder="{{ t.guestbook_message_placeholder }}"
            class="textarea textarea-bordered w-full h-28 resize-none rounded-xl bg-base-200/20 border-base-300/25 focus:border-primary/30 focus:bg-base-100 transition-all duration-200 p-3 text-sm"
            required
          ></textarea>
        </div>

        <div class="flex justify-end">
          <button type="submit" class="inline-flex items-center gap-2 px-5 py-2 bg-primary text-primary-content rounded-full text-sm font-medium shadow-sm shadow-primary/15 hover:shadow-md hover:shadow-primary/20 hover:-translate-y-0.5 transition-all duration-200">
            <i class="ph ph-paper-plane-right text-sm"></i>
            {{ t.guestbook_submit }}
          </button>
        </div>
      </form>
    </div>
  </div>

  <!-- Entries Section -->
  <div id="sort-content">
    <div class="flex items-center justify-between mb-6">
      <div class="flex items-center gap-2.5">
        <div class="w-8 h-8 rounded-lg bg-gradient-to-br from-primary/12 to-secondary/12 flex items-center justify-center">
          <i class="ph ph-chat-circle text-primary/60 text-sm"></i>
        </div>
        <h2 class="text-base font-semibold">{{ t.guestbook_recent }}</h2>
      </div>
      {% if sort_asc %}
      <a
        hx-get="?sort=desc"
        hx-target="#sort-content"
        hx-select="#sort-content"
        hx-swap="outerHTML transition:true"
        hx-push-url="true"
        class="inline-flex items-center gap-1.5 bg-base-200/50 hover:bg-primary/10 text-base-content/55 hover:text-primary rounded-full px-3.5 py-1.5 text-xs font-medium transition-all duration-200 cursor-pointer border border-base-300/15 hover:border-primary/20"
      >
        <i class="ph ph-sort-ascending text-sm"></i>
        {{ t.sort_oldest_first }}
      </a>
      {% else %}
      <a
        hx-get="?sort=asc"
        hx-target="#sort-content"
        hx-select="#sort-content"
        hx-swap="outerHTML transition:true"
        hx-push-url="true"
        class="inline-flex items-center gap-1.5 bg-base-200/50 hover:bg-primary/10 text-base-content/55 hover:text-primary rounded-full px-3.5 py-1.5 text-xs font-medium transition-all duration-200 cursor-pointer border border-base-300/15 hover:border-primary/20"
      >
        <i class="ph ph-sort-descending text-sm"></i>
        {{ t.sort_newest_first }}
      </a>
      {% endif %}
    </div>

    <div id="guestbook-entries" class="space-y-3">
      {% if entries.len() > 0 %} {% for entry in entries %}
      <div
        class="group relative rounded-2xl border border-base-300/15 hover:border-primary/15 bg-base-100/60 hover:bg-base-100 p-4 sm:p-5 transition-all duration-300 guestbook-item"
      >
        <!-- Author + Date row -->
        <div class="flex items-center justify-between mb-3">
          <div class="flex items-center gap-2.5">
            <!-- Avatar circle -->
            <div class="w-8 h-8 rounded-full bg-gradient-to-br from-primary/15 to-secondary/15 flex items-center justify-center flex-shrink-0">
              <span class="text-xs font-bold text-primary/60">{{ entry.author.chars().next().unwrap_or('?') }}</span>
            </div>
            <div class="flex flex-col sm:flex-row sm:items-baseline sm:gap-2">
              <span class="text-sm font-semibold text-base-content">{{ entry.author }}</span>
              <span class="text-[11px] text-base-content/35">
                {{ entry.created_at.format("%Y-%m-%d %H:%M") }}
              </span>
            </div>
          </div>

          <!-- Action buttons -->
          <div class="flex gap-0.5 opacity-0 group-hover:opacity-100 transition-opacity duration-200">
            {% if entry.password_hash.is_some() %}
            <button
              class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-primary/10 text-base-content/30 hover:text-primary transition-all duration-200 edit-btn"
              data-id="{{ entry.id }}"
              aria-label="Edit entry"
            >
              <i class="ph ph-pencil-simple text-sm"></i>
            </button>
            {% endif %}
            <button
              class="w-7 h-7 flex items-center justify-center rounded-full hover:bg-error/10 text-base-content/30 hover:text-error transition-all duration-200 delete-btn"
              data-id="{{ entry.id }}"
              aria-label="Delete entry"
            >
              <i class="ph ph-trash text-sm"></i>
            </button>
          </div>
        </div>

        <!-- Content -->
        <!-- prettier-ignore -->
        <div class="pl-[42px]">
          <p class="text-base-content/70 whitespace-pre-wrap leading-relaxed text-sm">{{ entry.content }}</p>
        </div>
      </div>
      {% endfor %}
    </div>

    <!-- Pagination -->
    {% if total_pages > 1 %}
    <div class="flex justify-center mt-8 mb-4">
      <div class="inline-flex items-center gap-1 bg-base-200/30 rounded-full px-2 py-1 border border-base-300/15">
        {% if let Some(prev) = prev_page %}
        <a
          href="?page={{ prev }}{% if sort_asc %}&sort=asc{% endif %}"
          class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-primary/10 hover:text-primary text-base-content/50 transition-all duration-200 text-sm"
        >
          <i class="ph ph-caret-left"></i>
        </a>
        {% endif %}
        {% for page_num in page_numbers %}
        <a
          href="?page={{ page_num }}{% if sort_asc %}&sort=asc{% endif %}"
          class="w-8 h-8 flex items-center justify-center rounded-full text-xs font-medium transition-all duration-200 {% if current_page|to_ref == page_num %}bg-primary text-primary-content shadow-sm{% else %}hover:bg-primary/10 hover:text-primary text-base-content/60{% endif %}"
        >{{ page_num }}</a>
        {% endfor %}
        {% if let Some(next) = next_page %}
        <a
          href="?page={{ next }}{% if sort_asc %}&sort=asc{% endif %}"
          class="w-8 h-8 flex items-center justify-center rounded-full hover:bg-primary/10 hover:text-primary text-base-content/50 transition-all duration-200 text-sm"
        >
          <i class="ph ph-caret-right"></i>
        </a>
        {% endif %}
      </div>
    </div>
    {% endif %}

    {% else %}
    <div class="flex flex-col items-center justify-center py-20 bg-base-100/60 rounded-2xl border border-base-300/15 text-center">
      <div class="w-14 h-14 rounded-2xl bg-gradient-to-br from-primary/8 to-secondary/8 flex items-center justify-center mb-4">
        <i class="ph ph-chat-circle text-2xl text-primary/25"></i>
      </div>
      <h3 class="text-base font-semibold mb-1.5">
        {{ t.guestbook_no_entries }}
      </h3>
      <p class="text-sm text-base-content/40">
        {{ t.guestbook_no_entries_message }}
      </p>
    </div>
    {% endif %}
  </div>
</div>

<style>
  .guestbook-item {
    opacity: 0;
    animation: gbFadeIn 0.4s ease-out forwards;
    animation-delay: calc(var(--i, 0) * 60ms);
  }
  .guestbook-item:nth-child(1) { --i: 0; }
  .guestbook-item:nth-child(2) { --i: 1; }
  .guestbook-item:nth-child(3) { --i: 2; }
  .guestbook-item:nth-child(4) { --i: 3; }
  .guestbook-item:nth-child(5) { --i: 4; }
  .guestbook-item:nth-child(6) { --i: 5; }
  .guestbook-item:nth-child(7) { --i: 6; }
  .guestbook-item:nth-child(8) { --i: 7; }
  .guestbook-item:nth-child(9) { --i: 8; }
  .guestbook-item:nth-child(10) { --i: 9; }

  @keyframes gbFadeIn {
    from {
      opacity: 0;
      transform: translateY(6px);
    }
    to {
      opacity: 1;
      transform: translateY(0);
    }
  }
</style>

<script>
  var i18nEl = document.getElementById("i18n-data");
  var i18n = i18nEl ? JSON.parse(i18nEl.textContent) : {};

  document.addEventListener("DOMContentLoaded", function () {
    // Guestbook form submission
    document
      .getElementById("guestbook-form")
      .addEventListener("submit", async function (e) {
        e.preventDefault();

        const author = document.getElementById("author").value;
        const content = document.getElementById("content").value;
        const password = document.getElementById("password").value;

        if (!author.trim() || !content.trim()) {
          alert(
            i18n.guestbook_enter_both || "Please enter both name and message.",
          );
          return;
        }

        try {
          const response = await fetch("/api/guestbook", {
            method: "POST",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              author,
              content,
              password: password || null,
            }),
          });

          if (response.ok) {
            document.getElementById("author").value = "";
            document.getElementById("content").value = "";
            document.getElementById("password").value = "";
            location.reload();
          } else {
            alert(
              i18n.guestbook_failed ||
                "Failed to post entry. Please try again.",
            );
          }
        } catch (error) {
          console.error("Error:", error);
          alert(i18n.comments_error || "An error occurred. Please try again.");
        }
      });

    // Edit entry functionality
    document.querySelectorAll(".edit-btn").forEach((btn) => {
      btn.addEventListener("click", async function () {
        const entryId = this.dataset.id;
        const entryContainer = this.closest(".group");
        const currentContent = entryContainer.querySelector(
          ".whitespace-pre-wrap",
        ).textContent;

        const password = prompt(
          i18n.comments_enter_password_edit || "Enter password to edit entry:",
        );
        if (!password) return;

        const newContent = prompt(
          i18n.comments_edit_prompt || "Edit your entry:",
          currentContent,
        );
        if (!newContent || newContent === currentContent) return;

        try {
          const response = await fetch(`/api/guestbook/edit/${entryId}`, {
            method: "PUT",
            headers: {
              "Content-Type": "application/json",
            },
            body: JSON.stringify({
              content: newContent,
              password,
            }),
          });

          if (response.ok) {
            const result = await response.json();
            if (result.success) {
              location.reload();
            } else {
              alert(
                i18n.comments_wrong_password ||
                  "Wrong password or entry not found.",
              );
            }
          } else {
            alert(i18n.comments_failed_edit || "Failed to edit entry.");
          }
        } catch (error) {
          console.error("Error:", error);
          alert(i18n.comments_error || "An error occurred.");
        }
      });
    });

    // Delete entry functionality
    document.querySelectorAll(".delete-btn").forEach((btn) => {
      btn.addEventListener("click", async function () {
        const entryId = this.dataset.id;

        const password = prompt(
          i18n.comments_enter_password_delete ||
            "Enter password to delete this entry:",
        );
        if (!password) return;

        if (
          confirm(
            i18n.comments_confirm_delete ||
              "Are you sure you want to delete this entry?",
          )
        ) {
          try {
            const response = await fetch(`/api/guestbook/delete/${entryId}`, {
              method: "DELETE",
              headers: {
                "Content-Type": "application/json",
              },
              body: JSON.stringify({ password }),
            });

            if (response.ok) {
              const result = await response.json();
              if (result.success) {
                location.reload();
              } else {
                alert(
                  i18n.comments_wrong_password ||
                    "Wrong password or entry not found.",
                );
              }
            } else {
              alert(i18n.comments_failed_edit || "Failed to delete entry.");
            }
          } catch (error) {
            console.error("Error:", error);
            alert(i18n.comments_error || "An error occurred.");
          }
        }
      });
    });
  });
</script>
{% endblock %}
